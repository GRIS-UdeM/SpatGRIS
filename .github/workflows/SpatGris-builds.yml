name: SpatGRIS CI

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  Build-Ubuntu-20-04:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
    steps:
      - name: Install required packages
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC
          apt-get update
          apt-get install -y git curl unzip sudo wget lsb-release software-properties-common make build-essential tzdata

      - name: Check out repository code with submodules
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Install latest Clang
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          ./llvm.sh 18
          apt-get install -y clang-18

      - name: Install dependencies # taken from https://github.com/juce-framework/JUCE/blob/develop/docs/Linux%20Dependencies.md
        run: |
          apt-get install -y ladspa-sdk freeglut3-dev libasound2-dev libcurl4-openssl-dev libfreetype6-dev \
              libxcomposite-dev libxcursor-dev libxinerama-dev libxrandr-dev mesa-common-dev libjack-jackd2-dev \
              libfontconfig1-dev libx11-dev libxext-dev libxrender-dev libwebkit2gtk-4.0-dev libglu1-mesa-dev

      - name: Cache Projucer Build
        id: cache-projucer
        uses: actions/cache@v4
        with:
          path: submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer
          key: projucer-cache-v1  # Manual version control, change v1 to force a rebuild
          restore-keys: |
            projucer-cache-

      - name: Debug Cache Path
        run: ls -lah submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/LinuxMakefile/build || echo "Cache path does not exist"

      - name: Build Projucer (if needed)
        if: steps.cache-projucer.outputs.cache-hit != 'true'
        run: |
          cd submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/LinuxMakefile
          make CXX=clang++-18 -j$(nproc)

      - name: Ensure Projucer is Executable
        run: chmod +x submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer

      - name: Generate Makefile
        run: |
          submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave SpatGRIS.jucer

      - name: Compile SpatGRIS
        run: cd Builds/LinuxMakefile && make CXX=clang++-18 CONFIG=Release -j$(nproc)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SpatGRIS-Build-Linux
          path: Builds/LinuxMakefile/build/*

  Build-macOS:
    runs-on: macos-13
    steps:
      - name: Check out repository code with submodules
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Install dependencies
        run: brew install jack

      - name: Debug CMake Path
        run: ls -R submodules/AlgoGRIS/submodules/JUCE/extras/Projucer

      - name: Build Projucer
        run: |
          cd submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/MacOSX
          xcodebuild -project Projucer.xcodeproj \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Generate Xcode project
        run: |
          chmod +x submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer
          submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer --resave SpatGRIS.jucer

      - name: build
        run: |
          xcodebuild -project Builds/MacOSX/SpatGRIS.xcodeproj \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SpatGRIS-Build-macOS
          path: Builds/MacOSX/build/Release/*

  Build-Windows:
    runs-on: windows-latest
    steps:
      - name: Check out repository code with submodules
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Download ASIO SDK
        run: curl -L https://www.steinberg.net/asiosdk --output ASIOSDK.zip

      - name: Unpack ASIO SDK
        run: Expand-Archive -Path ASIOSDK.zip -DestinationPath .

      - name: Download and Unpack JACK2 Source Code
        run: |
          curl -L -o jack2.zip https://github.com/jackaudio/jack2/archive/refs/tags/v1.9.22.zip
          Expand-Archive -Path jack2.zip -DestinationPath .

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build Projucer
        run: |
          cd submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/VisualStudio2022
          msbuild Projucer.sln /p:Configuration=Release /p:Platform=x64 /p:WarningsAsErrors=False

      - name: List directory contents
        run: ls -R

      - name: Generate Visual Studio project
        run: |
          submodules/AlgoGRIS/submodules/JUCE/extras/Projucer/Builds/VisualStudio2022/x64/Release/App/Projucer.exe --resave SpatGRIS.jucer

      - name: Set include paths
        run: echo "CL=/I ../../asiosdk_2.3.3_2019-06-14/common /I ../../jack2-1.9.22/common" >> $GITHUB_ENV

      - name: Build SpatGRIS
        run: msbuild Builds/VisualStudio2022/SpatGRIS_App.vcxproj -p:Configuration=Release -p:Platform=x64 -p:IncludePath=../../asiosdk_2.3.3_2019-06-14/common/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SpatGRIS-Build-Windows
          path: Builds/VisualStudio2022/x64/Release/**/*.exe
